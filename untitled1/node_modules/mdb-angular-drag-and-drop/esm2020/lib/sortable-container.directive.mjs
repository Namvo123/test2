import { Directive, ContentChildren, Output, EventEmitter, Input, InjectionToken, } from '@angular/core';
import { getElementRect } from './utilities';
import { MdbDraggableDirective } from './draggable.directive';
import * as i0 from "@angular/core";
export const MDB_SORTABLE_CONTAINER = new InjectionToken('MdbSortableContainer');
export class MdbSortableContainerDirective {
    constructor(_elementRef) {
        this._elementRef = _elementRef;
        this.autoScroll = false;
        this._containers = [];
        this.enterPredicate = () => true;
        this.sortingDisabled = false;
        this.itemDrop = new EventEmitter();
        this._inactiveItems = [];
        this._cachedDraggables = [];
        this._eventsInitialized = false;
        this._mouseEnterHandler = this._handleMouseEnter.bind(this);
        MdbSortableContainerDirective._sortableContainers.push(this);
    }
    get containers() {
        return this._containers;
    }
    set containers(containersArray) {
        this._containers = containersArray.map((container) => {
            if (typeof container === 'string') {
                return MdbSortableContainerDirective._sortableContainers.find((sortableContainer) => sortableContainer.id === container);
            }
            return container;
        });
    }
    get element() {
        return this._elementRef.nativeElement;
    }
    ngAfterContentInit() {
        this.draggables.forEach((draggable) => (draggable._sortableContainer = this));
        this._draggables = Array.from(this.draggables);
        this.draggables.changes.subscribe(() => {
            this.draggables.forEach((draggable) => (draggable._sortableContainer = this));
            this._draggables = Array.from(this.draggables);
        });
    }
    _onDragStart() {
        this.draggables.forEach((draggable) => (draggable._sortableContainer = this));
        this._draggables = Array.from(this.draggables);
        this._cacheDraggables();
    }
    _onDragEnd() {
        this._removeSortingEvents();
        this._eventsInitialized = false;
    }
    _emitDropEvent(item, previousContainer, newContainer, previousIndex, newIndex) {
        this.itemDrop.emit({
            item: item,
            previousContainer: previousContainer,
            newContainer: newContainer,
            previousIndex: previousIndex,
            newIndex: newIndex,
        });
    }
    _cacheDraggables() {
        this._cachedDraggables = this._draggables.map((draggable, index) => {
            const element = draggable._getHost();
            return {
                element: element,
                instance: draggable,
                offsetLeft: element.offsetLeft,
                offsetTop: element.offsetTop,
                translateX: 0,
                translateY: 0,
                index: index,
                rect: getElementRect(element),
            };
        });
    }
    _isPointerOverItem(rect, x, y) {
        const { top, bottom, left, right } = rect;
        const offset = 1;
        return (y + offset >= Math.floor(top) &&
            y - offset <= Math.floor(bottom) &&
            x + offset >= Math.floor(left) &&
            x - offset <= Math.floor(right));
    }
    _initSortingEvents(item) {
        if (!this._eventsInitialized) {
            this._setEvents(item);
            this._eventsInitialized = true;
        }
    }
    _removeSortingEvents() {
        this._draggables.forEach((item) => {
            const element = item._getHost();
            element.removeEventListener('mouseenter', this._mouseEnterHandler);
            element.style.transform = '';
            element.style.transition = '';
        });
    }
    _handleItemEnter(item, x, y) {
        this._eventsInitialized = false;
        this._cacheDraggables();
        const newIndex = this._getItemIndexFromCoordinates(x, y);
        const placeholder = item._getPlaceholder();
        let overItem = this._draggables[newIndex];
        let offsetLeft;
        let offsetTop;
        if (overItem) {
            const overItemElement = overItem._getHost();
            offsetLeft = overItemElement.offsetLeft;
            offsetTop = overItemElement.offsetTop;
            overItemElement.parentNode.insertBefore(placeholder, overItemElement);
            this._draggables.splice(newIndex, 0, item);
        }
        else {
            this.element.appendChild(placeholder);
            this._draggables.push(item);
        }
        placeholder.style.transform = '';
        this._cacheDraggables();
        if (overItem) {
            this._cachedDraggables[newIndex].offsetLeft = offsetLeft;
            this._cachedDraggables[newIndex].offsetTop = offsetTop;
        }
        else {
            const lastIndex = this._cachedDraggables.length - 1;
            this._cachedDraggables[lastIndex].offsetLeft = placeholder.offsetLeft;
            this._cachedDraggables[lastIndex].offsetTop = placeholder.offsetTop;
        }
        this._initSortingEvents(item);
    }
    _handleItemLeave(item) {
        const currentIndex = this._draggables.indexOf(item);
        this._draggables.splice(currentIndex, 1);
        this._removeSortingEvents();
    }
    _getItemIndexFromCoordinates(x, y) {
        return this._cachedDraggables.findIndex((draggable) => this._isPointerOverItem(draggable.rect, x, y));
    }
    _getContainerFromCoordinates(item, x, y) {
        return this.containers.find((container) => {
            if (container._canAcceptEnteringItem(item)) {
                return false;
            }
            const elementFromPoint = document.elementFromPoint(x, y);
            if (!elementFromPoint) {
                return false;
            }
            return container.element === elementFromPoint || container.element.contains(elementFromPoint);
        });
    }
    _canAcceptEnteringItem(item) {
        return !this.enterPredicate(item);
    }
    _setEvents(activeDraggable) {
        const inactiveSortItems = this._cachedDraggables.filter((draggable) => {
            if (draggable.instance === activeDraggable) {
                this._activeItem = draggable;
            }
            return draggable.instance !== activeDraggable;
        });
        this._inactiveItems = inactiveSortItems;
        if (!this.sortingDisabled) {
            inactiveSortItems.forEach((draggable) => {
                draggable.element.style.transition = `transform 300ms ease`;
                draggable.element.addEventListener('mouseenter', this._mouseEnterHandler);
            });
        }
    }
    _handleMouseEnter(event) {
        const enteredItem = this._getTarget(event);
        const itemBelow = enteredItem.index > this._activeItem.index;
        const itemsToMove = this._getItemsToMove(itemBelow, enteredItem);
        this._slideItems(itemBelow, itemsToMove);
        this._slideActiveItem(this._activeItem);
        this._activeItem.index = enteredItem.index;
        this._setIndexes(itemsToMove, itemBelow);
    }
    _getTarget(event) {
        return this._cachedDraggables.find((draggable) => draggable.element === event.target);
    }
    _slideItems(itemBelow, itemsToMove) {
        itemsToMove.forEach((item) => {
            const index = itemBelow ? item.index - 1 : item.index + 1;
            const adjacentItem = this._cachedDraggables[index];
            const distanceY = adjacentItem.offsetTop - item.offsetTop;
            const distanceX = adjacentItem.offsetLeft - item.offsetLeft;
            item.translateY = distanceY;
            item.translateX = distanceX;
            this._setTranslate(item.element, distanceX, distanceY);
        });
    }
    _slideActiveItem(item) {
        let sumY = 0;
        let sumX = 0;
        this._cachedDraggables.forEach((draggable) => {
            sumY -= draggable.translateY;
            sumX -= draggable.translateX;
        });
        const placeholder = item.instance._getPlaceholder();
        this._setTranslate(placeholder, sumX, sumY);
    }
    _getItemsToMove(itemBelow, enteredItem) {
        return this._cachedDraggables.filter((draggable) => {
            if (itemBelow) {
                return this._activeItem.index < draggable.index && draggable.index <= enteredItem.index;
            }
            return this._activeItem.index > draggable.index && draggable.index >= enteredItem.index;
        });
    }
    _setTranslate(element, x, y) {
        element.style.transform = `translate3d(${x}px, ${y}px, 0px)`;
    }
    _setIndexes(itemsToMove, itemBelow) {
        this._cachedDraggables = this._cachedDraggables.map((draggable) => {
            itemsToMove.forEach((item) => {
                if (draggable === item) {
                    if (itemBelow) {
                        item.index--;
                    }
                    else {
                        item.index++;
                    }
                }
            });
            return draggable;
        });
    }
    _setOffsets() {
        this._cachedDraggables.forEach((draggable) => {
            draggable.offsetLeft = draggable.element.offsetLeft;
            draggable.offsetTop = draggable.element.offsetTop;
        });
    }
    _resetTranslatesInfo() {
        this._cachedDraggables.forEach((draggable) => {
            draggable.translateX = 0;
            draggable.translateY = 0;
        });
    }
    _getDraggableIndex(item) {
        const correspondingItem = this._cachedDraggables.find((draggable) => draggable.instance === item);
        return correspondingItem.index;
    }
}
MdbSortableContainerDirective._sortableContainers = [];
MdbSortableContainerDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.3", ngImport: i0, type: MdbSortableContainerDirective, deps: [{ token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Directive });
MdbSortableContainerDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.2.3", type: MdbSortableContainerDirective, selector: "[mdbSortableContainer]", inputs: { autoScroll: "autoScroll", containers: "containers", data: "data", enterPredicate: "enterPredicate", id: "id", sortingDisabled: "sortingDisabled" }, outputs: { itemDrop: "itemDrop" }, providers: [{ provide: MDB_SORTABLE_CONTAINER, useExisting: MdbSortableContainerDirective }], queries: [{ propertyName: "draggables", predicate: MdbDraggableDirective }], exportAs: ["mdbSortableContainer"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.3", ngImport: i0, type: MdbSortableContainerDirective, decorators: [{
            type: Directive,
            args: [{
                    // eslint-disable-next-line @angular-eslint/directive-selector
                    selector: '[mdbSortableContainer]',
                    exportAs: 'mdbSortableContainer',
                    providers: [{ provide: MDB_SORTABLE_CONTAINER, useExisting: MdbSortableContainerDirective }],
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }]; }, propDecorators: { draggables: [{
                type: ContentChildren,
                args: [MdbDraggableDirective]
            }], autoScroll: [{
                type: Input
            }], containers: [{
                type: Input
            }], data: [{
                type: Input
            }], enterPredicate: [{
                type: Input
            }], id: [{
                type: Input
            }], sortingDisabled: [{
                type: Input
            }], itemDrop: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydGFibGUtY29udGFpbmVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21kYi1hbmd1bGFyLWRyYWctYW5kLWRyb3Avc3JjL2xpYi9zb3J0YWJsZS1jb250YWluZXIuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsZUFBZSxFQUdmLE1BQU0sRUFDTixZQUFZLEVBQ1osS0FBSyxFQUNMLGNBQWMsR0FDZixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDOztBQUc5RCxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLGNBQWMsQ0FDdEQsc0JBQXNCLENBQ3ZCLENBQUM7QUFRRixNQUFNLE9BQU8sNkJBQTZCO0lBK0N4QyxZQUFvQixXQUF1QjtRQUF2QixnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQTVDbEMsZUFBVSxHQUFHLEtBQUssQ0FBQztRQWdCcEIsZ0JBQVcsR0FBVSxFQUFFLENBQUM7UUFFdkIsbUJBQWMsR0FBNkMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDO1FBRXRFLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBRXZCLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBTXJDLG1CQUFjLEdBQXNCLEVBQUUsQ0FBQztRQUN2QyxzQkFBaUIsR0FBc0IsRUFBRSxDQUFDO1FBSTFDLHVCQUFrQixHQUFHLEtBQUssQ0FBQztRQUUzQix1QkFBa0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBVTdELDZCQUE2QixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBN0NELElBQ0ksVUFBVTtR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QyxJQUFJLENBQ3BFLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsUUFBUSxLQUFLLElBQUksQ0FDM0MsQ0FBQztRQUNGLE9BQU8saUJBQWlCLENBQUMsS0FBSyxDQUFDO0lBQ2pDLENBQUM7O0FBclNjLGlEQUFtQixHQUFvQyxFQUFHLENBQUE7MEhBM0I5RCw2QkFBNkI7OEdBQTdCLDZCQUE2QixrUEFGN0IsQ0FBQyxFQUFFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxXQUFXLEVBQUUsNkJBQTZCLEVBQUUsQ0FBQyxxREFHM0UscUJBQXFCOzJGQUQzQiw2QkFBNkI7a0JBTnpDLFNBQVM7bUJBQUM7b0JBQ1QsOERBQThEO29CQUM5RCxRQUFRLEVBQUUsd0JBQXdCO29CQUNsQyxRQUFRLEVBQUUsc0JBQXNCO29CQUNoQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxXQUFXLCtCQUErQixFQUFFLENBQUM7aUJBQzdGO2lHQUVpRCxVQUFVO3NCQUF6RCxlQUFlO3VCQUFDLHFCQUFxQjtnQkFFN0IsVUFBVTtzQkFBbEIsS0FBSztnQkFFRixVQUFVO3NCQURiLEtBQUs7Z0JBZ0JHLElBQUk7c0JBQVosS0FBSztnQkFDRyxjQUFjO3NCQUF0QixLQUFLO2dCQUNHLEVBQUU7c0JBQVYsS0FBSztnQkFDRyxlQUFlO3NCQUF2QixLQUFLO2dCQUVJLFFBQVE7c0JBQWpCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgUXVlcnlMaXN0LFxuICBBZnRlckNvbnRlbnRJbml0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIEluamVjdGlvblRva2VuLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGdldEVsZW1lbnRSZWN0IH0gZnJvbSAnLi91dGlsaXRpZXMnO1xuaW1wb3J0IHsgTWRiRHJhZ2dhYmxlRGlyZWN0aXZlIH0gZnJvbSAnLi9kcmFnZ2FibGUuZGlyZWN0aXZlJztcbmltcG9ydCB7IENhY2hlZERyYWdnYWJsZSB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgY29uc3QgTURCX1NPUlRBQkxFX0NPTlRBSU5FUiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxNZGJTb3J0YWJsZUNvbnRhaW5lckRpcmVjdGl2ZT4oXG4gICdNZGJTb3J0YWJsZUNvbnRhaW5lcidcbik7XG5cbkBEaXJlY3RpdmUoe1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogJ1ttZGJTb3J0YWJsZUNvbnRhaW5lcl0nLFxuICBleHBvcnRBczogJ21kYlNvcnRhYmxlQ29udGFpbmVyJyxcbiAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBNREJfU09SVEFCTEVfQ09OVEFJTkVSLCB1c2VFeGlzdGluZzogTWRiU29ydGFibGVDb250YWluZXJEaXJlY3RpdmUgfV0sXG59KVxuZXhwb3J0IGNsYXNzIE1kYlNvcnRhYmxlQ29udGFpbmVyRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gIEBDb250ZW50Q2hpbGRyZW4oTWRiRHJhZ2dhYmxlRGlyZWN0aXZlKSBwcml2YXRlIGRyYWdnYWJsZXM6IFF1ZXJ5TGlzdDxNZGJEcmFnZ2FibGVEaXJlY3RpdmU+O1xuXG4gIEBJbnB1dCgpIGF1dG9TY3JvbGwgPSBmYWxzZTtcbiAgQElucHV0KClcbiAgZ2V0IGNvbnRhaW5lcnMoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5fY29udGFpbmVycztcbiAgfVxuICBzZXQgY29udGFpbmVycyhjb250YWluZXJzQXJyYXk6IGFueSkge1xuICAgIHRoaXMuX2NvbnRhaW5lcnMgPSBjb250YWluZXJzQXJyYXkubWFwKChjb250YWluZXI6IGFueSkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBjb250YWluZXIgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybiBNZGJTb3J0YWJsZUNvbnRhaW5lckRpcmVjdGl2ZS5fc29ydGFibGVDb250YWluZXJzLmZpbmQoXG4gICAgICAgICAgKHNvcnRhYmxlQ29udGFpbmVyKSA9PiBzb3J0YWJsZUNvbnRhaW5lci5pZCA9PT0gY29udGFpbmVyXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb250YWluZXI7XG4gICAgfSk7XG4gIH1cbiAgcHJpdmF0ZSBfY29udGFpbmVyczogYW55W10gPSBbXTtcbiAgQElucHV0KCkgZGF0YTogYW55W107XG4gIEBJbnB1dCgpIGVudGVyUHJlZGljYXRlOiAoaXRlbTogTWRiRHJhZ2dhYmxlRGlyZWN0aXZlKSA9PiBib29sZWFuID0gKCkgPT4gdHJ1ZTtcbiAgQElucHV0KCkgaWQ6IHN0cmluZztcbiAgQElucHV0KCkgc29ydGluZ0Rpc2FibGVkID0gZmFsc2U7XG5cbiAgQE91dHB1dCgpIGl0ZW1Ecm9wID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgcHJpdmF0ZSBzdGF0aWMgX3NvcnRhYmxlQ29udGFpbmVyczogTWRiU29ydGFibGVDb250YWluZXJEaXJlY3RpdmVbXSA9IFtdO1xuXG4gIHByaXZhdGUgX2RyYWdnYWJsZXM6IE1kYkRyYWdnYWJsZURpcmVjdGl2ZVtdO1xuXG4gIHByaXZhdGUgX2luYWN0aXZlSXRlbXM6IENhY2hlZERyYWdnYWJsZVtdID0gW107XG4gIHByaXZhdGUgX2NhY2hlZERyYWdnYWJsZXM6IENhY2hlZERyYWdnYWJsZVtdID0gW107XG5cbiAgX2FjdGl2ZUl0ZW06IENhY2hlZERyYWdnYWJsZTtcblxuICBwcml2YXRlIF9ldmVudHNJbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX21vdXNlRW50ZXJIYW5kbGVyID0gdGhpcy5faGFuZGxlTW91c2VFbnRlci5iaW5kKHRoaXMpO1xuXG4gIGN1cnJlbnRJbmRleDogbnVtYmVyO1xuICBuZXdJbmRleDogbnVtYmVyO1xuXG4gIGdldCBlbGVtZW50KCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWxlbWVudFJlZjogRWxlbWVudFJlZikge1xuICAgIE1kYlNvcnRhYmxlQ29udGFpbmVyRGlyZWN0aXZlLl9zb3J0YWJsZUNvbnRhaW5lcnMucHVzaCh0aGlzKTtcbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLmRyYWdnYWJsZXMuZm9yRWFjaCgoZHJhZ2dhYmxlKSA9PiAoZHJhZ2dhYmxlLl9zb3J0YWJsZUNvbnRhaW5lciA9IHRoaXMpKTtcbiAgICB0aGlzLl9kcmFnZ2FibGVzID0gQXJyYXkuZnJvbSh0aGlzLmRyYWdnYWJsZXMpO1xuXG4gICAgdGhpcy5kcmFnZ2FibGVzLmNoYW5nZXMuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuZHJhZ2dhYmxlcy5mb3JFYWNoKChkcmFnZ2FibGUpID0+IChkcmFnZ2FibGUuX3NvcnRhYmxlQ29udGFpbmVyID0gdGhpcykpO1xuICAgICAgdGhpcy5fZHJhZ2dhYmxlcyA9IEFycmF5LmZyb20odGhpcy5kcmFnZ2FibGVzKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9vbkRyYWdTdGFydCgpIHtcbiAgICB0aGlzLmRyYWdnYWJsZXMuZm9yRWFjaCgoZHJhZ2dhYmxlKSA9PiAoZHJhZ2dhYmxlLl9zb3J0YWJsZUNvbnRhaW5lciA9IHRoaXMpKTtcbiAgICB0aGlzLl9kcmFnZ2FibGVzID0gQXJyYXkuZnJvbSh0aGlzLmRyYWdnYWJsZXMpO1xuICAgIHRoaXMuX2NhY2hlRHJhZ2dhYmxlcygpO1xuICB9XG5cbiAgX29uRHJhZ0VuZCgpIHtcbiAgICB0aGlzLl9yZW1vdmVTb3J0aW5nRXZlbnRzKCk7XG4gICAgdGhpcy5fZXZlbnRzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIF9lbWl0RHJvcEV2ZW50KFxuICAgIGl0ZW06IE1kYkRyYWdnYWJsZURpcmVjdGl2ZSxcbiAgICBwcmV2aW91c0NvbnRhaW5lcjogTWRiU29ydGFibGVDb250YWluZXJEaXJlY3RpdmUsXG4gICAgbmV3Q29udGFpbmVyOiBNZGJTb3J0YWJsZUNvbnRhaW5lckRpcmVjdGl2ZSxcbiAgICBwcmV2aW91c0luZGV4OiBudW1iZXIsXG4gICAgbmV3SW5kZXg6IG51bWJlclxuICApIHtcbiAgICB0aGlzLml0ZW1Ecm9wLmVtaXQoe1xuICAgICAgaXRlbTogaXRlbSxcbiAgICAgIHByZXZpb3VzQ29udGFpbmVyOiBwcmV2aW91c0NvbnRhaW5lcixcbiAgICAgIG5ld0NvbnRhaW5lcjogbmV3Q29udGFpbmVyLFxuICAgICAgcHJldmlvdXNJbmRleDogcHJldmlvdXNJbmRleCxcbiAgICAgIG5ld0luZGV4OiBuZXdJbmRleCxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2NhY2hlRHJhZ2dhYmxlcygpIHtcbiAgICB0aGlzLl9jYWNoZWREcmFnZ2FibGVzID0gdGhpcy5fZHJhZ2dhYmxlcy5tYXAoXG4gICAgICAoZHJhZ2dhYmxlOiBNZGJEcmFnZ2FibGVEaXJlY3RpdmUsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGRyYWdnYWJsZS5fZ2V0SG9zdCgpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZWxlbWVudDogZWxlbWVudCxcbiAgICAgICAgICBpbnN0YW5jZTogZHJhZ2dhYmxlLFxuICAgICAgICAgIG9mZnNldExlZnQ6IGVsZW1lbnQub2Zmc2V0TGVmdCxcbiAgICAgICAgICBvZmZzZXRUb3A6IGVsZW1lbnQub2Zmc2V0VG9wLFxuICAgICAgICAgIHRyYW5zbGF0ZVg6IDAsXG4gICAgICAgICAgdHJhbnNsYXRlWTogMCxcbiAgICAgICAgICBpbmRleDogaW5kZXgsXG4gICAgICAgICAgcmVjdDogZ2V0RWxlbWVudFJlY3QoZWxlbWVudCksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIF9pc1BvaW50ZXJPdmVySXRlbShyZWN0OiBhbnksIHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgY29uc3QgeyB0b3AsIGJvdHRvbSwgbGVmdCwgcmlnaHQgfSA9IHJlY3Q7XG4gICAgY29uc3Qgb2Zmc2V0ID0gMTtcblxuICAgIHJldHVybiAoXG4gICAgICB5ICsgb2Zmc2V0ID49IE1hdGguZmxvb3IodG9wKSAmJlxuICAgICAgeSAtIG9mZnNldCA8PSBNYXRoLmZsb29yKGJvdHRvbSkgJiZcbiAgICAgIHggKyBvZmZzZXQgPj0gTWF0aC5mbG9vcihsZWZ0KSAmJlxuICAgICAgeCAtIG9mZnNldCA8PSBNYXRoLmZsb29yKHJpZ2h0KVxuICAgICk7XG4gIH1cblxuICBfaW5pdFNvcnRpbmdFdmVudHMoaXRlbTogTWRiRHJhZ2dhYmxlRGlyZWN0aXZlKSB7XG4gICAgaWYgKCF0aGlzLl9ldmVudHNJbml0aWFsaXplZCkge1xuICAgICAgdGhpcy5fc2V0RXZlbnRzKGl0ZW0pO1xuICAgICAgdGhpcy5fZXZlbnRzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIF9yZW1vdmVTb3J0aW5nRXZlbnRzKCkge1xuICAgIHRoaXMuX2RyYWdnYWJsZXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgY29uc3QgZWxlbWVudCA9IGl0ZW0uX2dldEhvc3QoKTtcbiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIHRoaXMuX21vdXNlRW50ZXJIYW5kbGVyKTtcbiAgICAgIGVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gJyc7XG4gICAgICBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb24gPSAnJztcbiAgICB9KTtcbiAgfVxuXG4gIF9oYW5kbGVJdGVtRW50ZXIoaXRlbTogTWRiRHJhZ2dhYmxlRGlyZWN0aXZlLCB4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIHRoaXMuX2V2ZW50c0luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgdGhpcy5fY2FjaGVEcmFnZ2FibGVzKCk7XG5cbiAgICBjb25zdCBuZXdJbmRleCA9IHRoaXMuX2dldEl0ZW1JbmRleEZyb21Db29yZGluYXRlcyh4LCB5KTtcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IGl0ZW0uX2dldFBsYWNlaG9sZGVyKCk7XG4gICAgbGV0IG92ZXJJdGVtID0gdGhpcy5fZHJhZ2dhYmxlc1tuZXdJbmRleF07XG5cbiAgICBsZXQgb2Zmc2V0TGVmdDogbnVtYmVyO1xuICAgIGxldCBvZmZzZXRUb3A6IG51bWJlcjtcblxuICAgIGlmIChvdmVySXRlbSkge1xuICAgICAgY29uc3Qgb3Zlckl0ZW1FbGVtZW50ID0gb3Zlckl0ZW0uX2dldEhvc3QoKTtcbiAgICAgIG9mZnNldExlZnQgPSBvdmVySXRlbUVsZW1lbnQub2Zmc2V0TGVmdDtcbiAgICAgIG9mZnNldFRvcCA9IG92ZXJJdGVtRWxlbWVudC5vZmZzZXRUb3A7XG4gICAgICBvdmVySXRlbUVsZW1lbnQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIG92ZXJJdGVtRWxlbWVudCk7XG4gICAgICB0aGlzLl9kcmFnZ2FibGVzLnNwbGljZShuZXdJbmRleCwgMCwgaXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZWxlbWVudC5hcHBlbmRDaGlsZChwbGFjZWhvbGRlcik7XG4gICAgICB0aGlzLl9kcmFnZ2FibGVzLnB1c2goaXRlbSk7XG4gICAgfVxuXG4gICAgcGxhY2Vob2xkZXIuc3R5bGUudHJhbnNmb3JtID0gJyc7XG4gICAgdGhpcy5fY2FjaGVEcmFnZ2FibGVzKCk7XG5cbiAgICBpZiAob3Zlckl0ZW0pIHtcbiAgICAgIHRoaXMuX2NhY2hlZERyYWdnYWJsZXNbbmV3SW5kZXhdLm9mZnNldExlZnQgPSBvZmZzZXRMZWZ0O1xuICAgICAgdGhpcy5fY2FjaGVkRHJhZ2dhYmxlc1tuZXdJbmRleF0ub2Zmc2V0VG9wID0gb2Zmc2V0VG9wO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBsYXN0SW5kZXggPSB0aGlzLl9jYWNoZWREcmFnZ2FibGVzLmxlbmd0aCAtIDE7XG4gICAgICB0aGlzLl9jYWNoZWREcmFnZ2FibGVzW2xhc3RJbmRleF0ub2Zmc2V0TGVmdCA9IHBsYWNlaG9sZGVyLm9mZnNldExlZnQ7XG4gICAgICB0aGlzLl9jYWNoZWREcmFnZ2FibGVzW2xhc3RJbmRleF0ub2Zmc2V0VG9wID0gcGxhY2Vob2xkZXIub2Zmc2V0VG9wO1xuICAgIH1cblxuICAgIHRoaXMuX2luaXRTb3J0aW5nRXZlbnRzKGl0ZW0pO1xuICB9XG5cbiAgX2hhbmRsZUl0ZW1MZWF2ZShpdGVtOiBNZGJEcmFnZ2FibGVEaXJlY3RpdmUpIHtcbiAgICBjb25zdCBjdXJyZW50SW5kZXggPSB0aGlzLl9kcmFnZ2FibGVzLmluZGV4T2YoaXRlbSk7XG4gICAgdGhpcy5fZHJhZ2dhYmxlcy5zcGxpY2UoY3VycmVudEluZGV4LCAxKTtcbiAgICB0aGlzLl9yZW1vdmVTb3J0aW5nRXZlbnRzKCk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRJdGVtSW5kZXhGcm9tQ29vcmRpbmF0ZXMoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5fY2FjaGVkRHJhZ2dhYmxlcy5maW5kSW5kZXgoKGRyYWdnYWJsZSkgPT5cbiAgICAgIHRoaXMuX2lzUG9pbnRlck92ZXJJdGVtKGRyYWdnYWJsZS5yZWN0LCB4LCB5KVxuICAgICk7XG4gIH1cblxuICBfZ2V0Q29udGFpbmVyRnJvbUNvb3JkaW5hdGVzKGl0ZW06IE1kYkRyYWdnYWJsZURpcmVjdGl2ZSwgeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5jb250YWluZXJzLmZpbmQoKGNvbnRhaW5lcikgPT4ge1xuICAgICAgaWYgKGNvbnRhaW5lci5fY2FuQWNjZXB0RW50ZXJpbmdJdGVtKGl0ZW0pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZWxlbWVudEZyb21Qb2ludCA9IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQoeCwgeSk7XG5cbiAgICAgIGlmICghZWxlbWVudEZyb21Qb2ludCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb250YWluZXIuZWxlbWVudCA9PT0gZWxlbWVudEZyb21Qb2ludCB8fCBjb250YWluZXIuZWxlbWVudC5jb250YWlucyhlbGVtZW50RnJvbVBvaW50KTtcbiAgICB9KTtcbiAgfVxuXG4gIF9jYW5BY2NlcHRFbnRlcmluZ0l0ZW0oaXRlbTogTWRiRHJhZ2dhYmxlRGlyZWN0aXZlKSB7XG4gICAgcmV0dXJuICF0aGlzLmVudGVyUHJlZGljYXRlKGl0ZW0pO1xuICB9XG5cbiAgX3NldEV2ZW50cyhhY3RpdmVEcmFnZ2FibGU6IE1kYkRyYWdnYWJsZURpcmVjdGl2ZSkge1xuICAgIGNvbnN0IGluYWN0aXZlU29ydEl0ZW1zID0gdGhpcy5fY2FjaGVkRHJhZ2dhYmxlcy5maWx0ZXIoKGRyYWdnYWJsZSkgPT4ge1xuICAgICAgaWYgKGRyYWdnYWJsZS5pbnN0YW5jZSA9PT0gYWN0aXZlRHJhZ2dhYmxlKSB7XG4gICAgICAgIHRoaXMuX2FjdGl2ZUl0ZW0gPSBkcmFnZ2FibGU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkcmFnZ2FibGUuaW5zdGFuY2UgIT09IGFjdGl2ZURyYWdnYWJsZTtcbiAgICB9KTtcblxuICAgIHRoaXMuX2luYWN0aXZlSXRlbXMgPSBpbmFjdGl2ZVNvcnRJdGVtcztcblxuICAgIGlmICghdGhpcy5zb3J0aW5nRGlzYWJsZWQpIHtcbiAgICAgIGluYWN0aXZlU29ydEl0ZW1zLmZvckVhY2goKGRyYWdnYWJsZSkgPT4ge1xuICAgICAgICBkcmFnZ2FibGUuZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uID0gYHRyYW5zZm9ybSAzMDBtcyBlYXNlYDtcbiAgICAgICAgZHJhZ2dhYmxlLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIHRoaXMuX21vdXNlRW50ZXJIYW5kbGVyKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2hhbmRsZU1vdXNlRW50ZXIoZXZlbnQ6IGFueSkge1xuICAgIGNvbnN0IGVudGVyZWRJdGVtOiBhbnkgPSB0aGlzLl9nZXRUYXJnZXQoZXZlbnQpO1xuXG4gICAgY29uc3QgaXRlbUJlbG93ID0gZW50ZXJlZEl0ZW0uaW5kZXggPiB0aGlzLl9hY3RpdmVJdGVtLmluZGV4O1xuXG4gICAgY29uc3QgaXRlbXNUb01vdmUgPSB0aGlzLl9nZXRJdGVtc1RvTW92ZShpdGVtQmVsb3csIGVudGVyZWRJdGVtKTtcblxuICAgIHRoaXMuX3NsaWRlSXRlbXMoaXRlbUJlbG93LCBpdGVtc1RvTW92ZSk7XG4gICAgdGhpcy5fc2xpZGVBY3RpdmVJdGVtKHRoaXMuX2FjdGl2ZUl0ZW0pO1xuXG4gICAgdGhpcy5fYWN0aXZlSXRlbS5pbmRleCA9IGVudGVyZWRJdGVtLmluZGV4O1xuXG4gICAgdGhpcy5fc2V0SW5kZXhlcyhpdGVtc1RvTW92ZSwgaXRlbUJlbG93KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFRhcmdldChldmVudDogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuX2NhY2hlZERyYWdnYWJsZXMuZmluZCgoZHJhZ2dhYmxlKSA9PiBkcmFnZ2FibGUuZWxlbWVudCA9PT0gZXZlbnQudGFyZ2V0KTtcbiAgfVxuXG4gIF9zbGlkZUl0ZW1zKGl0ZW1CZWxvdzogYm9vbGVhbiwgaXRlbXNUb01vdmU6IENhY2hlZERyYWdnYWJsZVtdKSB7XG4gICAgaXRlbXNUb01vdmUuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgY29uc3QgaW5kZXggPSBpdGVtQmVsb3cgPyBpdGVtLmluZGV4IC0gMSA6IGl0ZW0uaW5kZXggKyAxO1xuICAgICAgY29uc3QgYWRqYWNlbnRJdGVtID0gdGhpcy5fY2FjaGVkRHJhZ2dhYmxlc1tpbmRleF07XG5cbiAgICAgIGNvbnN0IGRpc3RhbmNlWSA9IGFkamFjZW50SXRlbS5vZmZzZXRUb3AgLSBpdGVtLm9mZnNldFRvcDtcbiAgICAgIGNvbnN0IGRpc3RhbmNlWCA9IGFkamFjZW50SXRlbS5vZmZzZXRMZWZ0IC0gaXRlbS5vZmZzZXRMZWZ0O1xuXG4gICAgICBpdGVtLnRyYW5zbGF0ZVkgPSBkaXN0YW5jZVk7XG4gICAgICBpdGVtLnRyYW5zbGF0ZVggPSBkaXN0YW5jZVg7XG5cbiAgICAgIHRoaXMuX3NldFRyYW5zbGF0ZShpdGVtLmVsZW1lbnQsIGRpc3RhbmNlWCwgZGlzdGFuY2VZKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9zbGlkZUFjdGl2ZUl0ZW0oaXRlbTogQ2FjaGVkRHJhZ2dhYmxlKSB7XG4gICAgbGV0IHN1bVkgPSAwO1xuICAgIGxldCBzdW1YID0gMDtcblxuICAgIHRoaXMuX2NhY2hlZERyYWdnYWJsZXMuZm9yRWFjaCgoZHJhZ2dhYmxlKSA9PiB7XG4gICAgICBzdW1ZIC09IGRyYWdnYWJsZS50cmFuc2xhdGVZO1xuICAgICAgc3VtWCAtPSBkcmFnZ2FibGUudHJhbnNsYXRlWDtcbiAgICB9KTtcblxuICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gaXRlbS5pbnN0YW5jZS5fZ2V0UGxhY2Vob2xkZXIoKTtcblxuICAgIHRoaXMuX3NldFRyYW5zbGF0ZShwbGFjZWhvbGRlciwgc3VtWCwgc3VtWSk7XG4gIH1cblxuICBfZ2V0SXRlbXNUb01vdmUoaXRlbUJlbG93OiBib29sZWFuLCBlbnRlcmVkSXRlbTogQ2FjaGVkRHJhZ2dhYmxlKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NhY2hlZERyYWdnYWJsZXMuZmlsdGVyKChkcmFnZ2FibGUpID0+IHtcbiAgICAgIGlmIChpdGVtQmVsb3cpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2ZUl0ZW0uaW5kZXggPCBkcmFnZ2FibGUuaW5kZXggJiYgZHJhZ2dhYmxlLmluZGV4IDw9IGVudGVyZWRJdGVtLmluZGV4O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5fYWN0aXZlSXRlbS5pbmRleCA+IGRyYWdnYWJsZS5pbmRleCAmJiBkcmFnZ2FibGUuaW5kZXggPj0gZW50ZXJlZEl0ZW0uaW5kZXg7XG4gICAgfSk7XG4gIH1cblxuICBfc2V0VHJhbnNsYXRlKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCB4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIGVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eH1weCwgJHt5fXB4LCAwcHgpYDtcbiAgfVxuXG4gIF9zZXRJbmRleGVzKGl0ZW1zVG9Nb3ZlOiBDYWNoZWREcmFnZ2FibGVbXSwgaXRlbUJlbG93OiBib29sZWFuKSB7XG4gICAgdGhpcy5fY2FjaGVkRHJhZ2dhYmxlcyA9IHRoaXMuX2NhY2hlZERyYWdnYWJsZXMubWFwKChkcmFnZ2FibGUpID0+IHtcbiAgICAgIGl0ZW1zVG9Nb3ZlLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKGRyYWdnYWJsZSA9PT0gaXRlbSkge1xuICAgICAgICAgIGlmIChpdGVtQmVsb3cpIHtcbiAgICAgICAgICAgIGl0ZW0uaW5kZXgtLTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXRlbS5pbmRleCsrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBkcmFnZ2FibGU7XG4gICAgfSk7XG4gIH1cblxuICBfc2V0T2Zmc2V0cygpIHtcbiAgICB0aGlzLl9jYWNoZWREcmFnZ2FibGVzLmZvckVhY2goKGRyYWdnYWJsZSkgPT4ge1xuICAgICAgZHJhZ2dhYmxlLm9mZnNldExlZnQgPSBkcmFnZ2FibGUuZWxlbWVudC5vZmZzZXRMZWZ0O1xuICAgICAgZHJhZ2dhYmxlLm9mZnNldFRvcCA9IGRyYWdnYWJsZS5lbGVtZW50Lm9mZnNldFRvcDtcbiAgICB9KTtcbiAgfVxuXG4gIF9yZXNldFRyYW5zbGF0ZXNJbmZvKCkge1xuICAgIHRoaXMuX2NhY2hlZERyYWdnYWJsZXMuZm9yRWFjaCgoZHJhZ2dhYmxlKSA9PiB7XG4gICAgICBkcmFnZ2FibGUudHJhbnNsYXRlWCA9IDA7XG4gICAgICBkcmFnZ2FibGUudHJhbnNsYXRlWSA9IDA7XG4gICAgfSk7XG4gIH1cblxuICBfZ2V0RHJhZ2dhYmxlSW5kZXgoaXRlbTogTWRiRHJhZ2dhYmxlRGlyZWN0aXZlKSB7XG4gICAgY29uc3QgY29ycmVzcG9uZGluZ0l0ZW06IENhY2hlZERyYWdnYWJsZSA9IHRoaXMuX2NhY2hlZERyYWdnYWJsZXMuZmluZChcbiAgICAgIChkcmFnZ2FibGUpID0+IGRyYWdnYWJsZS5pbnN0YW5jZSA9PT0gaXRlbVxuICAgICk7XG4gICAgcmV0dXJuIGNvcnJlc3BvbmRpbmdJdGVtLmluZGV4O1xuICB9XG59XG4iXX0=